<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>登录 - 自主学习控制台</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/modderui/modder-ui.css">
    <link rel="stylesheet" href="/static/modderui/modder-ui-ios-mode.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body data-mode="ios" data-theme="light">

    <!-- Theme toggle -->
    <div class="theme-toggle-corner">
        <button class="btn btn-ghost" id="themeToggle" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:50%;">
            <i class="material-icons" id="themeIcon">dark_mode</i>
        </button>
    </div>

    <div class="login-page">
        <div class="login-card" id="login-container" style="display:flex;flex-direction:column;align-items:center;width:100%;max-width:380px;">
            <!-- Logo -->
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="material-icons">psychology</i>
                </div>
                <h1>控制台登录</h1>
                <p class="subtitle">自学习插件管理系统</p>
            </div>

            <!-- Card form area -->
            <div class="card card-blurred" style="padding:24px;width:100%;box-sizing:border-box;">
                <!-- Messages -->
                <div id="errorMessage" class="error-message" style="display:none;margin-bottom:16px;padding:10px 14px;border-radius:10px;font-size:13px;"></div>
                <div id="successMessage" class="success-message" style="display:none;margin-bottom:16px;padding:10px 14px;border-radius:10px;font-size:13px;"></div>

                <!-- Form -->
                <form id="loginForm" autocomplete="off">
                    <div style="margin-bottom:6px;">
                        <label style="display:block;font-size:13px;font-weight:500;color:var(--modder-text-secondary-label);margin-bottom:6px;">登录密码</label>
                    </div>
                    <div class="form-input-group" style="margin-bottom:20px;">
                        <span class="form-input-icon">
                            <i class="material-icons" style="font-size:18px;">lock</i>
                        </span>
                        <input type="password" id="password" name="password" class="form-input"
                               placeholder="请输入登录密码" required autocomplete="current-password">
                    </div>

                    <button type="submit" class="btn btn-default" id="submitBtn"
                            style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;">
                        <div class="loading-spinner" id="loadingSpinner" style="display:none;width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;"></div>
                        <span id="btnText">登录</span>
                    </button>
                </form>

                <!-- Security tip -->
                <div class="security-tip" style="margin-top:16px;">
                    <i class="material-icons" style="font-size:16px;color:var(--modder-text-tertiary-label);">shield</i>
                    <span>请确保在安全环境中使用</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle
        (function() {
            const saved = localStorage.getItem('sl-theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                const icon = document.getElementById('themeIcon');
                if (icon) icon.textContent = saved === 'dark' ? 'light_mode' : 'dark_mode';
            }
            document.getElementById('themeToggle').addEventListener('click', function() {
                const current = document.body.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', next);
                localStorage.setItem('sl-theme', next);
                document.getElementById('themeIcon').textContent = next === 'dark' ? 'light_mode' : 'dark_mode';
            });
        })();

        document.addEventListener('DOMContentLoaded', function () {
            const loginContainer = document.getElementById('login-container');
            const loginButton = document.getElementById('submitBtn');
            const passwordInput = document.getElementById('password');
            const loginMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');

            // Focus password input
            passwordInput.focus();

            function showError(message) {
                loginMessage.innerHTML = '<i class="material-icons" style="font-size:14px;margin-right:6px;vertical-align:middle;">error_outline</i>' + message;
                loginMessage.style.display = 'flex';
                loginMessage.style.alignItems = 'center';
                successMessage.style.display = 'none';

                loginMessage.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(function() { loginMessage.style.animation = ''; }, 500);
            }

            function showSuccess(message) {
                successMessage.innerHTML = '<i class="material-icons" style="font-size:14px;margin-right:6px;vertical-align:middle;">check_circle</i>' + message;
                successMessage.style.display = 'flex';
                successMessage.style.alignItems = 'center';
                loginMessage.style.display = 'none';
            }

            function setLoading(loading) {
                if (loading) {
                    loadingSpinner.style.display = 'block';
                    btnText.textContent = '登录中...';
                    loginButton.disabled = true;
                } else {
                    loadingSpinner.style.display = 'none';
                    btnText.textContent = '登录';
                    loginButton.disabled = false;
                }
            }

            // Check URL params for forced password change
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('must_change') === 'true') {
                window.location.href = '/api/plugin_change_password';
                return;
            }

            // Show login page
            loginContainer.style.display = '';

            loginButton.addEventListener('click', async function(e) {
                e.preventDefault();
                const password = passwordInput.value.trim();

                if (!password) {
                    showError('请输入登录密码');
                    passwordInput.focus();
                    return;
                }

                setLoading(true);

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (data.must_change) {
                            showSuccess('登录成功，需要更改默认密码');
                            setTimeout(function() {
                                window.location.href = '/api/plugin_change_password';
                            }, 1500);
                        } else {
                            showSuccess('登录成功，正在跳转...');
                            setTimeout(function() {
                                window.location.href = data.redirect || '/api/index';
                            }, 1000);
                        }
                    } else if (response.status === 429) {
                        showError(data.error || '登录尝试次数过多，请稍后重试');
                        loginButton.disabled = true;
                        btnText.textContent = '已锁定 (' + (data.remaining_time || 300) + '秒)';

                        var remaining = data.remaining_time || 300;
                        var countdownInterval = setInterval(function() {
                            remaining--;
                            if (remaining <= 0) {
                                clearInterval(countdownInterval);
                                loginButton.disabled = false;
                                btnText.textContent = '登录';
                            } else {
                                btnText.textContent = '已锁定 (' + remaining + '秒)';
                            }
                        }, 1000);
                    } else {
                        var errorMsg = data.error || '登录失败，请检查密码';
                        showError(errorMsg);
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showError('网络连接失败，请检查网络后重试');
                } finally {
                    setLoading(false);
                }
            });

            // Enter key submit
            passwordInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    loginButton.click();
                }
            });
        });
    </script>
</body>

</html>
