<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>更改密码 - 自主学习控制台</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/modderui/modder-ui.css">
    <link rel="stylesheet" href="/static/modderui/modder-ui-ios-mode.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body data-mode="ios" data-theme="light">

    <!-- Theme toggle -->
    <div class="theme-toggle-corner">
        <button class="btn btn-ghost" id="themeToggle" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:50%;">
            <i class="material-icons" id="themeIcon">dark_mode</i>
        </button>
    </div>

    <div class="password-page">
        <div class="password-card">
            <!-- Header -->
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="material-icons">lock_reset</i>
                </div>
                <h1>更改登录密码</h1>
                <p class="subtitle">为了账户安全，请设置一个强密码</p>
            </div>

            <!-- Card form area -->
            <div class="card card-blurred" style="padding:24px;">
                <!-- Messages -->
                <div id="errorMessage" class="error-message" style="display:none;margin-bottom:16px;padding:10px 14px;border-radius:10px;font-size:13px;"></div>
                <div id="successMessage" class="success-message" style="display:none;margin-bottom:16px;padding:10px 14px;border-radius:10px;font-size:13px;"></div>

                <!-- Form -->
                <form id="changePasswordForm" autocomplete="off">
                    <!-- Old password -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block;font-size:13px;font-weight:500;color:var(--modder-text-secondary-label);margin-bottom:6px;">当前密码</label>
                        <div class="form-input-group">
                            <span class="form-input-icon">
                                <i class="material-icons" style="font-size:18px;">vpn_key</i>
                            </span>
                            <input type="password" id="oldPassword" name="oldPassword" class="form-input"
                                   placeholder="请输入当前密码" required autocomplete="current-password">
                        </div>
                    </div>

                    <!-- New password -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block;font-size:13px;font-weight:500;color:var(--modder-text-secondary-label);margin-bottom:6px;">新密码</label>
                        <div class="form-input-group">
                            <span class="form-input-icon">
                                <i class="material-icons" style="font-size:18px;">lock</i>
                            </span>
                            <input type="password" id="newPassword" name="newPassword" class="form-input"
                                   placeholder="请输入新密码" required autocomplete="new-password">
                        </div>
                        <!-- Password strength -->
                        <div id="passwordStrength" style="display:none;margin-top:8px;">
                            <div class="password-strength-bar">
                                <div class="password-strength-fill" id="strengthFill"></div>
                            </div>
                            <div id="strengthText" style="font-size:11px;font-weight:500;"></div>
                        </div>
                    </div>

                    <!-- Confirm password -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block;font-size:13px;font-weight:500;color:var(--modder-text-secondary-label);margin-bottom:6px;">确认新密码</label>
                        <div class="form-input-group" id="confirmGroup">
                            <span class="form-input-icon">
                                <i class="material-icons" style="font-size:18px;">lock_outline</i>
                            </span>
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input"
                                   placeholder="请再次输入新密码" required autocomplete="new-password">
                        </div>
                    </div>

                    <!-- Password requirements -->
                    <div class="password-requirements">
                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:13px;font-weight:600;color:var(--modder-text-label);">
                            <i class="material-icons" style="font-size:16px;color:var(--modder-text-accent-primary);">info</i>
                            <span>密码要求</span>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                            <div class="requirement-item" id="req-length-row">
                                <i class="material-icons" id="req-length" style="font-size:16px;">radio_button_unchecked</i>
                                <span>至少8个字符长度</span>
                            </div>
                            <div class="requirement-item" id="req-different-row">
                                <i class="material-icons" id="req-different" style="font-size:16px;">radio_button_unchecked</i>
                                <span>不能与当前密码相同</span>
                            </div>
                            <div class="requirement-item" id="req-complexity-row" style="grid-column:1/-1;">
                                <i class="material-icons" id="req-complexity" style="font-size:16px;">radio_button_unchecked</i>
                                <span>建议包含大小写字母、数字和符号</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-default btn-lg" id="submitBtn"
                            style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;">
                        <div class="loading-spinner" id="loadingSpinner" style="display:none;width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;"></div>
                        <span id="btnText">更改密码</span>
                    </button>
                </form>
            </div>

            <!-- Footer -->
            <div class="password-footer">
                <a href="/api/index" style="display:inline-flex;align-items:center;gap:4px;color:var(--modder-text-accent-primary);font-size:14px;font-weight:500;">
                    <i class="material-icons" style="font-size:18px;">arrow_back</i>
                    <span>返回控制台</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle
        (function() {
            const saved = localStorage.getItem('sl-theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                const icon = document.getElementById('themeIcon');
                if (icon) icon.textContent = saved === 'dark' ? 'light_mode' : 'dark_mode';
            }
            document.getElementById('themeToggle').addEventListener('click', function() {
                const current = document.body.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', next);
                localStorage.setItem('sl-theme', next);
                document.getElementById('themeIcon').textContent = next === 'dark' ? 'light_mode' : 'dark_mode';
            });
        })();

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('changePasswordForm');
            const oldPasswordInput = document.getElementById('oldPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const passwordStrength = document.getElementById('passwordStrength');

            const reqLength = document.getElementById('req-length');
            const reqDifferent = document.getElementById('req-different');
            const reqComplexity = document.getElementById('req-complexity');

            oldPasswordInput.focus();

            function showError(message) {
                errorMessage.innerHTML = '<i class="material-icons" style="font-size:14px;margin-right:6px;vertical-align:middle;">error_outline</i>' + message;
                errorMessage.style.display = 'flex';
                errorMessage.style.alignItems = 'center';
                successMessage.style.display = 'none';

                errorMessage.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(function() { errorMessage.style.animation = ''; }, 500);
            }

            function showSuccess(message) {
                successMessage.innerHTML = '<i class="material-icons" style="font-size:14px;margin-right:6px;vertical-align:middle;">check_circle</i>' + message;
                successMessage.style.display = 'flex';
                successMessage.style.alignItems = 'center';
                errorMessage.style.display = 'none';
            }

            function hideMessages() {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
            }

            function setLoading(loading) {
                if (loading) {
                    loadingSpinner.style.display = 'block';
                    btnText.textContent = '更改中...';
                    submitBtn.disabled = true;
                } else {
                    loadingSpinner.style.display = 'none';
                    btnText.textContent = '更改密码';
                    submitBtn.disabled = false;
                }
            }

            function checkPasswordStrength(password) {
                var strength = 0;
                var checks = {
                    length: password.length >= 8,
                    lowercase: /[a-z]/.test(password),
                    uppercase: /[A-Z]/.test(password),
                    numbers: /\d/.test(password),
                    symbols: /[^A-Za-z0-9]/.test(password)
                };

                strength += checks.length ? 1 : 0;
                strength += checks.lowercase ? 1 : 0;
                strength += checks.uppercase ? 1 : 0;
                strength += checks.numbers ? 1 : 0;
                strength += checks.symbols ? 1 : 0;

                return { strength: strength, checks: checks };
            }

            function updatePasswordStrength(password) {
                var result = checkPasswordStrength(password);
                var fill = document.getElementById('strengthFill');
                var text = document.getElementById('strengthText');

                if (!password) {
                    passwordStrength.style.display = 'none';
                    return;
                }

                passwordStrength.style.display = 'block';

                fill.className = 'password-strength-fill';
                if (result.strength <= 2) {
                    fill.classList.add('weak');
                    text.textContent = '弱';
                    text.style.color = 'var(--sl-danger)';
                } else if (result.strength <= 3) {
                    fill.classList.add('medium');
                    text.textContent = '中等';
                    text.style.color = 'var(--sl-warning)';
                } else {
                    fill.classList.add('strong');
                    text.textContent = '强';
                    text.style.color = 'var(--sl-success)';
                }
            }

            function updateRequirements() {
                var oldPassword = oldPasswordInput.value;
                var newPassword = newPasswordInput.value;
                var result = checkPasswordStrength(newPassword);

                // Length check
                if (result.checks.length) {
                    reqLength.textContent = 'check_circle';
                    reqLength.style.color = 'var(--sl-success)';
                } else {
                    reqLength.textContent = 'radio_button_unchecked';
                    reqLength.style.color = '';
                }

                // Different password check
                if (newPassword && newPassword !== oldPassword) {
                    reqDifferent.textContent = 'check_circle';
                    reqDifferent.style.color = 'var(--sl-success)';
                } else {
                    reqDifferent.textContent = 'radio_button_unchecked';
                    reqDifferent.style.color = '';
                }

                // Complexity check
                var complexityScore = [result.checks.lowercase, result.checks.uppercase, result.checks.numbers, result.checks.symbols].filter(Boolean).length;
                if (complexityScore >= 2) {
                    reqComplexity.textContent = 'check_circle';
                    reqComplexity.style.color = 'var(--sl-success)';
                } else {
                    reqComplexity.textContent = 'radio_button_unchecked';
                    reqComplexity.style.color = '';
                }
            }

            function validateForm() {
                var oldPassword = oldPasswordInput.value.trim();
                var newPassword = newPasswordInput.value.trim();
                var confirmPassword = confirmPasswordInput.value.trim();

                if (!oldPassword) { showError('请输入当前密码'); oldPasswordInput.focus(); return false; }
                if (!newPassword) { showError('请输入新密码'); newPasswordInput.focus(); return false; }
                if (newPassword.length < 8) { showError('新密码至少需要8个字符'); newPasswordInput.focus(); return false; }
                if (newPassword === oldPassword) { showError('新密码不能与当前密码相同'); newPasswordInput.focus(); return false; }
                if (newPassword !== confirmPassword) { showError('新密码和确认密码不匹配'); confirmPasswordInput.focus(); return false; }
                return true;
            }

            newPasswordInput.addEventListener('input', function() {
                updatePasswordStrength(this.value);
                updateRequirements();
            });

            oldPasswordInput.addEventListener('input', updateRequirements);

            confirmPasswordInput.addEventListener('input', function() {
                var confirmGroup = document.getElementById('confirmGroup');
                if (this.value) {
                    if (this.value === newPasswordInput.value) {
                        confirmGroup.style.borderColor = 'var(--sl-success)';
                    } else {
                        confirmGroup.style.borderColor = 'var(--sl-danger)';
                    }
                } else {
                    confirmGroup.style.borderColor = '';
                }
            });

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                hideMessages();

                if (!validateForm()) return;

                setLoading(true);

                try {
                    var response = await fetch('/api/plugin_change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            old_password: oldPasswordInput.value,
                            new_password: newPasswordInput.value
                        })
                    });

                    var data = await response.json();

                    if (response.ok) {
                        showSuccess('密码更改成功！正在跳转到登录页面...');
                        form.reset();
                        passwordStrength.style.display = 'none';
                        document.getElementById('confirmGroup').style.borderColor = '';

                        setTimeout(function() {
                            window.location.href = '/api/index';
                        }, 2000);
                    } else {
                        showError(data.error || '密码更改失败，请重试');
                        oldPasswordInput.value = '';
                        oldPasswordInput.focus();
                    }
                } catch (error) {
                    console.error('Change password error:', error);
                    showError('网络连接失败，请检查网络后重试');
                } finally {
                    setLoading(false);
                }
            });

            // Enter key navigation
            [oldPasswordInput, newPasswordInput, confirmPasswordInput].forEach(function(input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        if (input === oldPasswordInput) {
                            newPasswordInput.focus();
                        } else if (input === newPasswordInput) {
                            confirmPasswordInput.focus();
                        } else {
                            form.dispatchEvent(new Event('submit'));
                        }
                    }
                });
            });
        });

        // Legacy compatibility
        async function changePassword() {
            document.getElementById('changePasswordForm').dispatchEvent(new Event('submit'));
        }

        function showMessage(msg, type) {
            var errorMessage = document.getElementById('errorMessage');
            var successMessage = document.getElementById('successMessage');

            if (type === 'error') {
                errorMessage.innerHTML = '<i class="material-icons" style="font-size:14px;margin-right:6px;vertical-align:middle;">error_outline</i>' + msg;
                errorMessage.style.display = 'flex';
                errorMessage.style.alignItems = 'center';
                successMessage.style.display = 'none';
            } else if (type === 'success') {
                successMessage.innerHTML = '<i class="material-icons" style="font-size:14px;margin-right:6px;vertical-align:middle;">check_circle</i>' + msg;
                successMessage.style.display = 'flex';
                successMessage.style.alignItems = 'center';
                errorMessage.style.display = 'none';
            }
        }
    </script>
</body>
</html>
